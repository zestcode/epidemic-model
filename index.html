<!DOCTYPE HTML>
<html>
	<head>
		<title>疫情传播模型</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="./main.css" />
		<script src = "https://d3js.org/d3.v4.min.js"></script>
        <script src = "./event.js"></script>
        <style  type="text/css">
        body
        .value{text-align: center;font-weight: bold;font-size: 1em; letter-spacing: -0.07em;text-shadow: white 2px 2px 2px;}
        input[type="range"] {display: block;-webkit-appearance: none;background-color: #bdc3c7;width: 100%;height: 10px;border-radius: 5px;margin: 0 auto;outline: 0;}
        input[type="range"]::-webkit-slider-thumb {-webkit-appearance: none;background-color:black;width: 15px;height: 15px;border-radius: 50%;border: 2px solid white;cursor: pointer;transition: 0.3s ease-in-out;}
        .range{position:relative;left:-100px;width:70px;margin:0 auto;}
        .rang_width{position:absolute;top:-33px;left:px;background:black;height:10px;border-radius:5px 0 0 5px;}
        </style>
	</head>
	<body class="homepage is-preload">
		<div id="page-wrapper">

			<!-- Header -->
				<section id="header">
					<div class="container">

						<!-- Logo -->
							<h1 id="logo"><a href="index.html"></a></h1>
							<p></p>

						<!-- Nav -->
							<nav id="nav">
								<ul >
									<li ><img src="./1.ico" height="25" width="25"><button >口罩百分率</button></img></li>
									<li ><img src="./2.ico" height="25" width="25"><button > 死亡百分率</button></img></li>
									<li ><img src="./3.ico" height="25" width="25"><button > 人数初始设置</button></img></li>
									<li ><img src="./4.ico" height="25" width="25"><button >社交距离</button></img></li>
									<li ><img src="./5.ico" height="25" width="25"><button >时间速率调节</button></img></li>
								</ul>
                            </nav>
                    </div>
                    <div style="height: 2px"id=Sl0 class="range" >
                        <input id=Sl01 type="range" min="0" max="100" step="1" value="0" onclick='g(this.id)'>
                        <p id=Sl02 class="rang_width"></p>
                        <div id=Sl03 class="value">0</div>
                      </div>
                    <div style="height: 2px" id=Sl1 class="range">
                        <input id=Sl11 type="range" min="0" max="100" step="1" value="0" onclick='g(this.id)'>
                        <p id=Sl12 class="rang_width"></p>
                        <div id=Sl13 class="value">0</div>
                    </div>
                    <div style="height: 2px" id=Sl2 class="range">
                        <input id=Sl21 type="range" min="0" max="2000" step="1" value="0" onclick='g(this.id)'>
                        <p id=Sl22 class="rang_width"></p>
                        <div id=Sl23 class="value">0</div>
                    </div>
                    <div style="height:2px" id=Sl3 class="range">
                      <input id=Sl31 type="range" min="0" max="200" step="1" value="0" onclick='g(this.id)' >
                      <p id=Sl32 class="rang_width"></p>
                      <div id=Sl33 class="value">0</div>
                    </div>
                    <div style="height: 2px" id=Sl4 class="range">
                      <input id=Sl41 type="range" min="0" max="2000" step="1" value="0" onclick='g(this.id)'>
                      <p id=Sl42 class="rang_width"></p>
                      <div id=Sl43 class="value">0</div>
                    </div>                    
                </section>   
		</div>         
	<script>
      for(num=0;num<=4;num++)
    {
    var changeSlPosId="Sl"+String(num);
    var changeSlPoselem=document.getElementById(changeSlPosId);
    changeSlPoselem.style.left=String(-270+num*150)+"px";
    changeSlPoselem.style.top=String(-num*5)+"px";
    }
        var num=0;
        var Id="Sl"+String(num);
        var firstId=Id+'1';
        var elem = document.getElementById(firstId);
        var rangeValue0 = function(){
        var newValue = elem.value;
        var valueId=Id+'3';
        var target = document.getElementById(valueId);
        target.innerHTML = newValue;
        var max = elem.getAttribute("max");
        var width = (92.3 / max * newValue) +"%";
        var rangewithId=Id+'2';
        document.getElementById(rangewithId).style.width = width;
      };
        elem.addEventListener("input", rangeValue0);
        
        
        
        var Id1="Sl1";
        var firstId1=Id1+'1';
        var elem1 = document.getElementById(firstId1);

        var rangeValue1 = function(){
        var newValue = elem1.value;
        var valueId=Id1+'3';
        var target = document.getElementById(valueId);
        target.innerHTML = newValue;
        var max = elem1.getAttribute("max");
        var width = (92.3 / max * newValue) +"%";
        var rangewithId=Id1+'2';
        document.getElementById(rangewithId).style.width = width;
      };
    elem1.addEventListener("input", rangeValue1);
        
    
        var Id2="Sl2";
        var firstId2=Id2+'1';
        var elem2 = document.getElementById(firstId2);

        var rangeValue2 = function(){
        var newValue = elem2.value;
        var valueId=Id2+'3';
        var target = document.getElementById(valueId);
        target.innerHTML = newValue;
        var max = elem2.getAttribute("max");
        var width = (92.3 / max * newValue) +"%";
        var rangewithId=Id2+'2';
        document.getElementById(rangewithId).style.width = width;
      };
    elem2.addEventListener("input", rangeValue2);
      
    
        var Id3="Sl3";
        var firstId3=Id3+'1';
        var elem3 = document.getElementById(firstId3);

        var rangeValue3 = function(){
        var newValue = elem3.value;
        var valueId=Id3+'3';
        var target = document.getElementById(valueId);
        target.innerHTML = newValue;
        var max = elem3.getAttribute("max");
        var width = (92.3 / max * newValue) +"%";
        var rangewithId=Id3+'2';
        document.getElementById(rangewithId).style.width = width;
      };
    elem3.addEventListener("input", rangeValue3);
    

    var Id4="Sl4";
        var firstId4=Id4+'1';
        var elem4 = document.getElementById(firstId4);

        var rangeValue4 = function(){
        var newValue = elem4.value;
        var valueId=Id4+'3';
        var target = document.getElementById(valueId);
        target.innerHTML = newValue;
        var max = elem4.getAttribute("max");
        var width = (92.3 / max * newValue) +"%";
        var rangewithId=Id4+'2';
        document.getElementById(rangewithId).style.width = width;
      };
    elem4.addEventListener("input", rangeValue4);
    function g(x)
    {
    d=document.getElementById(x);
    d.style.background.color= "red" ;
    if(x=='Sl01')
    {
       // init();
        posb_infection_contacted=5;
        infection_radio=20*2;//the radio of infection
        resistence_radio=50*6;
    }
    if(x=='Sl11'){
        //init();
        death_rate=0.001;
       // d.style.background='green';
    }
    if(x=='Sl21') {
        d3.select('svg').remove();   //删除整个SVG
        d3.select('svg')
            .selectAll('*')
            .remove();   
        //init();   
        start = Date.now(),
        frames = 0;
        num_init=1000;
        procced();
    }
    if(x=='Sl31')
    {
        //init();
        speedadd=1000;
        
    }
    if(x=='Sl41')
    {
        //init();
        k_resistence=0;
        speedadd=10;
    }
    }
    init();
    procced();
    var record_health=[],record_dead=[],record_quarantine=[],
    record_sick=[];
//var person = new Person("Tom", 25, "Software Engineer");
   d3.timer(function () {
    // Update the FPS meter.
    var now = Date.now(), duration = now - start;
    //text.text(~~(++frames * 1000 / duration));
    if (duration >= 1000)  {
        record_health.push(count_healthy);
        record_dead.push(count_dead);
        record_quarantine.push(count_quarantine);
        record_sick.push(count_sick);
        frames++;
        start = now;
    }
    if(frames%60==0)
    {
        localStorage.setItem(String(frames/60)+"h",JSON.stringify(record_health));
        localStorage.setItem(String(frames/60)+"s",JSON.stringify(record_sick));
        localStorage.setItem(String(frames/60)+"q",JSON.stringify(record_quarantine));
        localStorage.setItem(String(frames/60)+"d",JSON.stringify(record_dead));
    }
    // Update the circle positions.
    count_healthy=0;
    count_sick=0;
    count_contacted=0;
    count_dead=0;
    count_quarantine=0;
    //count the number of all things 
    

    circle
        .attr("cx", function (d) {
            if(the_world==1) return d.x;
            if(d.color=="#CCCCCC")return d.x; d.x += d.dx; 
            if(d.color=='#66CCFF'&&d.x<w-200)
            {
                d.dx=0.5+1*Math.random();d.dy=Math.random();
            }
//start to move
            if(movleft==1&&d.x>(rectx+10)&&d.x<(rectx+rectw-10)&&(d.y>recty+10)&&d.y<(recty+recth-10))
            {
                d.dy=1*Math.random()+0.5;
                d.ismov=1;
                d.wasgather=0;
            }
//is moving
            if(d.ismov==1)
            {
                if(d.x<rectx||d.x>(rectx+rectw)) d.dx=-d.dx;
                d.dy=1*Math.random()+0.5;
                if(d.y>(endy+50))
                {
                    var angle=Math.random()*Math.PI*2;
                    var speed=Math.random()*0.5+0.1;
                    d.dx=Math.cos(angle)*speed;
                    d.dy=Math.sin(angle)*speed;
                    d.ismov=0;
                    d.wasmov=1;
                }
            }
//reach the end
            if(d.wasmov==1&&endr==0)
            {
                if(d.x<(endx+10)||d.x>(endx+endw-10)) d.dx=-d.dx;
                if(d.y<(endy+10)||d.y>(endy+endh-10)) d.dy=-d.dy;
            }

//horn
            if(gather==1)
                if(d.color!="#66CCFF"&&d.color!="#CCCCCC")
                    if(d.ismov==0&&d.wasmov==0)
                        if(d.x>(rectx+rectw-10)||d.x<(rectx+5)||d.y<(recty+10)||d.y>(recty+recth-10))
                            d.isgather=1;
            if(gather==0) d.isgather=0;
            if(d.isgather==1)
            {
                var disx=(rectx+0.5*rectw)-d.x;
                var disy=(recty+0.5*recth)-d.y;
                var dis=Math.hypot(disx,disy);
                var v=2*Math.random();
                d.dx=v*disx/dis;
                d.dy=v*disy/dis;
                if(d.x>(rectx+5)&&(d.x<(rectx+rectw-10))&&d.y>(recty+10)&&d.y<(recty+recth-10))//d is in rect
                {
                    var angle=Math.random()*Math.PI*2;
                    var speed=Math.random()*0.5+0.1;
                    d.dx=Math.cos(angle)*speed;
                    d.dy=Math.sin(angle)*speed;
                    d.isgather=0;d.wasgather=1;
                    
                }
                if(rectr==0&&d.wasgather==1)
                {
                    if(d.x<(rectx+5)||d.x>(rectx+rectw-10)) d.dx=-d.dx;
                    if(d.y<(recty+10)||d.y>(recty+recth-10)) d.dy=-d.dy;
                }       
            }

//relief
        


        if (d.color!="#66CCFF"&&d.x > w-230||d.x<0) d.dx=-d.dx;
            else if(d.color=="#66CCFF"&&d.x>w||d.x<0||(d.opacity==1&&d.x<w-200)) d.dx=-d.dx; 
        return d.x; })
        .attr("cy", function (d) {if(the_world==1||d.color=="#CCCCCC")return d.y; d.y += d.dy; if (d.y > h || d.y < 0) d.dy=-d.dy; return d.y; })
        .style("fill",function(d){
            switch(d.color)
            {
                case "#FF0000":
                    count_sick++;break;
                case "#CCCCCC":
                    count_dead++;break;
                case "#98FB98":
                    count_healthy++;break;
                case "#FFFF00":
                    count_contacted++;break;
                case "#66CCFF":
                    count_quarantine++;break;
            }

            if(the_world==1) return d.color;
            if(d.color=="#FF0000")
            {
                if(Math.random()<death_rate)
                {
                    d.color="#CCCCCC";
                }else if(Math.random()<health_rate)
                {
                    d.color="#98FB98";//be cured
                }
            }
            

            if(d.color=="#CCCCCC"||d.color=="#66CCFF")return d.color;
            var ax=0,ay=0;
            x=circle.each(function(e,i)
            {
                if(e.color=="#CCCCCC"||e.color=="#66CCFF")return d.color;
                if(e!=d)
                {
                    
                    var distance=Math.hypot(e.x-d.x,e.y-d.y);
                    //not everyone want to touch other easily so we choose to use a repulsion
                    if(distance==0)
                        distance=0.001;//to avoid the NaN
                    if(d.isgather==0&&d.wasgather==0)
                    {
                        if(distance<resistence_radio)//social disconnection
                    {
                        ax+=(e.x-d.x)/(distance*distance);
                        ay+=(e.y-d.y)/(distance*distance);
                    }}
                    if(e.color=="#FF0000")
                    {//touch the patient
                        
                        if(distance<infection_radio)
                        {
                            var posb=posb_infection_contacted/(distance*distance+0.01)-0.01;
                            //the posibility of infection is inversely proportional to distance
                            if(Math.random()<posb)//the possibility of infection each frame
                                    d.color="#FF0000";//marked as a patient
                            else
                                if(d.color=="#98FB98")
                                    d.color="#FFFF00";//marked as a close contact
                        }
                    }
                }
            });
            d.dx+=ax*k_resistence*speedadd;
            d.dy+=ay*k_resistence*speedadd;
            if(Math.hypot(d.dx,d.dy)>0.6)
            {
                var v=Math.hypot(d.dx,d.dy);
                d.dx=0.6*d.dx/v;
                d.dy=0.6*d.dy/v;
            }
            return d.color;
        })
        .on("click",function(d){if(d.color!="#CCCCCC"&&d.color!="#66CCFF") d.color="#FF0000";})
        .on("dblclick",function(d){if(d.color=="#FF0000") d.color="#66CCFF";})
        .attr("opacity",function(d){
            if(d.color=="#66CCFF"&&d.x<w-200)
                return 0.2;
            return 1;
        });

    //button
        document.onkeydown = function(e)
        {
            var e = e || event || arguments[0];
                if(e.keyCode==83)movleft=(movleft+1)%2;//"s" down
                if(e.keyCode==17) the_world=(the_world+1)%2;//ctrl
                if(e.keyCode==82){endr=(endr+1)%2;}//r
                if(e.keyCode==84){rectr=(rectr+1)%2;}//t
            
        }
    d3.select("#start").attr("stroke",function(d)
    {
        if(rectr==1) return "#CCCCCC";
            else return "#000000";
    })
    d3.select("#endd").attr("stroke",function(d)
    {
        if(endr==1) return "#CCCCCC";
            else return "#000000";
    })
//horn
    d3.select("#horn")
    .on("click",function(d){gather=(gather+1)%2;})
    .style("fill",function(d)
    {
        if(gather==1) return "#FF0000";
        else return "#CCCCCC";
    })

//begin update text
    text.selectAll("tspan").remove();
    text.selectAll("tspan")
    .data(Array("healthy:"+count_healthy,
                "contacted:"+count_contacted,
                "sick:"+count_sick,
                "dead:"+count_dead,
                "quarantine:"+count_quarantine
                )) 
    .enter() 
    .append("tspan") 
    .attr("x",text.attr("x")) 
    .attr("dy","1em") 
    .text(function(d){ 
     return d; 
    });
    //end update text

//begin update rect
/*    rect
        .attr("y",function(d,i){
            return h-d.num()*rectH;
        } )
        .attr("height",function(d,i){
            return d.num()*rectH;} );*/
//end update rect
    }
);
    </script>
						
	</body>
</html>
